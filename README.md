# exmaple run
<img width="1512" height="982" alt="Screenshot 2025-10-22 at 6 38 46‚ÄØPM (2)" src="https://github.com/user-attachments/assets/2c73fb3f-b485-4fd7-83be-4bdb3f2d3710" />


readme generated by claude-4.5-sonnet

# Kalshi Correlator

Live correlation and divergence signals for Kalshi prediction markets. Analyze correlations between market movements to find trading opportunities and understand market relationships.

## Features

- üìä **Candlestick Data Visualization** - Display price charts for any Kalshi market
- üîó **Cross-Event Correlation Analysis** - Calculate correlations between markets from different events
- üìà **Time Series Analysis** - Analyze price movements and returns over time
- üéØ **Market Discovery** - Find markets with similar or opposite movements
- üìâ **Rolling Correlations** - Track how correlations change over time
- üèÜ **Top Correlations** - Identify the most correlated market pairs

> **Note**: The analyzer automatically excludes within-event correlations to focus on meaningful cross-event relationships. Markets within the same event are often mechanically related and less interesting for correlation analysis.

## Setup

```bash
npm install
```

## Quick Start

### 1. Configure Environment Variables

Create a `.env` file in the project root:

```bash
cp .env.example .env
```

Then edit `.env` with your Kalshi API credentials:

```env
KALSHI_API_KEY=your-api-key-id
KALSHI_PRIVATE_KEY_PATH=path/to/your/private-key.pem
KALSHI_BASE_PATH=https://api.elections.kalshi.com/trade-api/v2
```

**Alternative:** Export environment variables directly in your shell:

```bash
export KALSHI_API_KEY="your-api-key-id"
export KALSHI_PRIVATE_KEY_PATH="path/to/your/private-key.pem"
```

### 2. Run the Correlation Analysis

```bash
npm run dev
```

This will:
- Fetch up to 200 active events from Kalshi
- **Filter for markets with volume > 100k** (liquid markets only)
- Collect up to 100 high-volume markets from unique events
- Display a sample price chart
- Perform rolling window analysis (50 markets per window)
- Show correlation matrix with strength indicators
- Display top 20 correlated market pairs

**Analysis Scale:**
- Window 1: First 50 markets (~1,225 correlations)
- Window 2: Markets 51-100 (~1,225 correlations)
- Total: Up to 100 unique markets analyzed
- **Volume Filter**: Only markets with total volume > 100,000 contracts

### 3. Run the Correlation Example

For a detailed walkthrough of correlation analysis features:

```bash
npm run correlation
```

This example demonstrates:
- Analyzing specific market pairs
- Multi-market correlation analysis
- Finding markets correlated with a specific target

## Authentication

The SDK uses RSA-PSS signing for authentication. You can provide your private key in two ways:

**Option 1: File Path**
```typescript
const config = new Configuration({
    apiKey: 'your-api-key-id',
    privateKeyPath: 'path/to/private-key.pem',
    basePath: 'https://api.elections.kalshi.com/trade-api/v2'
});
```

**Option 2: PEM String**
```typescript
const config = new Configuration({
    apiKey: 'your-api-key-id',
    privateKeyPem: '-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----',
    basePath: 'https://api.elections.kalshi.com/trade-api/v2'
});
```

## Usage Examples

### Basic Correlation Analysis

```typescript
import { KalshiCorrelator } from "./quickstart.js";
import { CorrelationAnalyzer } from "./correlation-analyzer.js";

// Initialize
const kalshi = new KalshiCorrelator();
const analyzer = new CorrelationAnalyzer(kalshi);

// Define markets to analyze
const markets = [
  {
    eventTicker: "EVENT-1",
    marketTicker: "MARKET-1",
    title: "Market 1 Title",
    eventTitle: "Event 1 Title"
  },
  {
    eventTicker: "EVENT-2",
    marketTicker: "MARKET-2",
    title: "Market 2 Title",
    eventTitle: "Event 2 Title"
  }
];

// Define time range (last 30 days)
const endTs = Math.floor(Date.now() / 1000);
const startTs = endTs - 60 * 60 * 24 * 30;

// Analyze correlations
const correlations = await analyzer.analyzeMultipleMarkets(
  markets,
  startTs,
  endTs,
  "60" // 1-hour intervals
);

// Display results
analyzer.displayCorrelationMatrix(correlations, 0.3);
```

### Finding Top Correlations

```typescript
// Get top 10 most correlated pairs
const topCorrelations = analyzer.findTopCorrelations(correlations, 10);

topCorrelations.forEach((result) => {
  console.log(`${result.market1} ‚Üî ${result.market2}: ${result.correlation.toFixed(3)}`);
});
```

### Finding Markets Correlated with a Specific Market

```typescript
// Find markets correlated with a target market
const targetMarket = "MARKET-1";
const correlated = analyzer.findCorrelatedWith(
  targetMarket,
  correlations,
  0.3 // correlation threshold
);

correlated.forEach((result) => {
  const otherMarket = result.market1 === targetMarket 
    ? result.market2 
    : result.market1;
  console.log(`${otherMarket}: ${result.correlation.toFixed(3)}`);
});
```

### Analyzing a Specific Market Pair

```typescript
const result = await analyzer.analyzeMarketPair(
  "EVENT-1",
  "MARKET-1",
  "Market 1 Title",
  "EVENT-2",
  "MARKET-2",
  "Market 2 Title",
  startTs,
  endTs,
  "60"
);

if (result) {
  console.log(`Correlation: ${result.correlation.toFixed(3)}`);
  console.log(`Data points: ${result.dataPoints}`);
}
```

## Understanding Correlation Values

- **1.0 to 0.7**: Strong positive correlation - markets move together
- **0.7 to 0.3**: Moderate positive correlation
- **0.3 to -0.3**: Weak or no correlation
- **-0.3 to -0.7**: Moderate negative correlation - markets move opposite
- **-0.7 to -1.0**: Strong negative correlation

The analyzer calculates correlations on **returns** (price changes) rather than absolute prices, which is more meaningful for financial time series analysis.

## Why Cross-Event Analysis?

The correlation analyzer focuses on **cross-event correlations** only, automatically excluding markets from the same event. Here's why:

### Within-Event Markets (Excluded)
Markets in the same event are often mechanically related:
- **Example**: "Will Team A win?" vs "Will Team B win?" in a two-team game
- These markets are **perfectly negatively correlated** by design
- They provide little insight for trading strategies

### Cross-Event Markets (Analyzed)
Markets from different events reveal genuine market relationships:
- **Example**: "Fed rate decision" correlated with "Tech stock predictions"
- These correlations indicate real economic/social relationships
- They can signal trading opportunities and arbitrage strategies

The analyzer collects **one market per event** to maximize the diversity of cross-event pairs analyzed.

## Configuration

You can easily adjust the analysis parameters at the top of `src/index.ts`:

```typescript
// Configuration
const VOLUME_THRESHOLD = 100000; // Minimum market volume (contracts)
const MAX_MARKETS = 100; // Maximum markets to analyze
const WINDOW_SIZE = 50; // Markets per analysis window
```

**Parameters:**
- **VOLUME_THRESHOLD**: Minimum trading volume required for a market to be included (default: 100,000 contracts)
- **MAX_MARKETS**: Maximum number of markets to collect from unique events (default: 100)
- **WINDOW_SIZE**: Number of markets analyzed in each rolling window (default: 50)

## Volume Filtering

The correlation analyzer filters for **high-volume markets only** (volume > 100,000 contracts by default):

### Why Filter by Volume?

**High-Volume Markets** (analyzed):
- More reliable price discovery
- Better liquidity = more meaningful price movements
- Stronger signals with less noise
- Reflects genuine market sentiment

**Low-Volume Markets** (excluded):
- Price movements may be random or illiquid
- Correlations less statistically meaningful
- Higher bid-ask spreads lead to noisy data
- May lack sufficient trading activity for analysis

### How It Works

When collecting markets, the analyzer:
1. Checks each market's total volume
2. Skips markets with volume ‚â§ 100k
3. Takes the first high-volume market from each event
4. Reports how many low-volume events were skipped

**Example Output:**
```
Collecting one market from each unique event (volume > 100k)...
  1. MARKET-ABC (vol: 450k) from "Event Title"
  ...
‚ö†Ô∏è  Skipped 45 event(s) with volume ‚â§ 100k
‚úì Collected 100 markets from unique events
```

## Performance & Scalability

### Rolling Window Analysis

The analyzer uses a **rolling window approach** to efficiently handle large numbers of markets:

- **Window Size**: 50 markets per window
- **Total Capacity**: 100 markets across 2 windows
- **Why Rolling Windows?**
  - Manages API rate limits
  - Provides progress feedback during long-running analysis
  - Allows for parallel processing in future versions
  - Reduces memory footprint

### Analysis Complexity

For N markets, the number of pairwise correlations is: `N √ó (N - 1) / 2`

- 10 markets = 45 correlations
- 50 markets = 1,225 correlations
- 100 markets = 4,950 correlations

The rolling window approach keeps memory usage manageable while analyzing thousands of correlations.

### Optimization Features

- **Smart Progress Logging**: Shows updates every 10th market during data fetching
- **Deduplication**: Automatically removes duplicate pairs from overlapping windows
- **Sparse Logging**: Summarizes same-event skips instead of logging each one
- **Efficient Alignment**: Only calculates correlations for markets with sufficient overlapping data

## Development Commands

### Development Mode
```bash
npm run dev
```

### Correlation Example
```bash
npm run correlation
```

### Build
```bash
npm run build
```

### Production
```bash
npm start
```

### Watch Mode
```bash
npm run watch:build
```

## Project Structure

```
src/
‚îú‚îÄ‚îÄ index.ts                 # Main entry point with correlation analysis
‚îú‚îÄ‚îÄ config.ts                # Configuration management
‚îú‚îÄ‚îÄ quickstart.ts            # Kalshi SDK wrapper
‚îú‚îÄ‚îÄ candlestick-plotter.ts   # Price chart visualization
‚îú‚îÄ‚îÄ correlation-analyzer.ts  # Correlation analysis engine
‚îî‚îÄ‚îÄ correlation-example.ts   # Detailed usage examples
```

## Key Components

### CorrelationAnalyzer

The main class for performing correlation analysis:

- `fetchMarketTimeSeries()` - Fetch candlestick data and convert to time series
- `analyzeMultipleMarkets()` - Analyze correlations across multiple markets
- `analyzeMarketPair()` - Analyze correlation between two specific markets
- `calculateCorrelation()` - Calculate Pearson correlation coefficient
- `displayCorrelationMatrix()` - Display formatted correlation results
- `findTopCorrelations()` - Get most correlated market pairs
- `findCorrelatedWith()` - Find markets correlated with a target
- `deduplicateCorrelations()` - Remove duplicate pairs from rolling window results

### KalshiCorrelator

Wrapper around the Kalshi SDK for easy access:

- `getEvents(limit)` - Fetch events with nested markets (default: 200 events)
- `getMarketCandlesticks()` - Fetch OHLC candlestick data
- `getBalance()` - Get account balance
- `getMarkets()` - Get list of markets

## Resources

- [Kalshi TypeScript SDK (NPM)](https://www.npmjs.com/package/kalshi-typescript)
- [Kalshi API Documentation](https://api.elections.kalshi.com/trade-api/v2/docs)

